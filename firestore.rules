rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserAgencyId() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null && userDoc.data != null ? userDoc.data.agency_id : null;
    }
    
    function getUserRole() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null && userDoc.data != null ? userDoc.data.role : null;
    }
    
    function isAdmin() {
      return getUserRole() == 'admin';
    }
    
    function isEmployee() {
      return getUserRole() == 'employee';
    }
    
    function isCustomer() {
      return getUserRole() == 'customer';
    }
    
    function isAccountant() {
      return getUserRole() == 'accountant' || getUserRole() == 'admin';
    }
    
    function isLoanOfficer() {
      let userRole = getUserRole();
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      let employeeCategory = userDoc != null && userDoc.data != null ? userDoc.data.employee_category : null;
      return isAdmin() || isEmployee() || userRole == 'loan_officer' || employeeCategory == 'loan_officer';
    }
    
    function getUserEmployeeCategory() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null && userDoc.data != null ? userDoc.data.employee_category : null;
    }
    
    function belongsToAgency(agencyId) {
      let userAgencyId = getUserAgencyId();
      return userAgencyId == agencyId;
    }
    
    function isCustomerOwner(customerId, agencyId) {
      let customerDoc = get(/databases/$(database)/documents/agencies/$(agencyId)/customers/$(customerId));
      return customerDoc != null && customerDoc.data.userId == request.auth.uid;
    }
    
    function isLoanOwner(loanId, agencyId) {
      let loanDoc = get(/databases/$(database)/documents/agencies/$(agencyId)/loans/$(loanId));
      return loanDoc != null && loanDoc.data.customerId != null 
        ? isCustomerOwner(loanDoc.data.customerId, agencyId) 
        : false;
    }
    
    // Plan and feature helpers
    function getAgencyPlan(agencyId) {
      let agencyDoc = get(/databases/$(database)/documents/agencies/$(agencyId));
      return agencyDoc != null && agencyDoc.data != null ? agencyDoc.data.plan : null;
    }
    
    function hasFeature(agencyId, featureName) {
      let agencyDoc = get(/databases/$(database)/documents/agencies/$(agencyId));
      return agencyDoc != null 
        && agencyDoc.data != null 
        && agencyDoc.data.features != null
        && agencyDoc.data.features[featureName] == true;
    }
    
    function getLoanTypeLimit(agencyId) {
      let agencyDoc = get(/databases/$(database)/documents/agencies/$(agencyId));
      return agencyDoc != null && agencyDoc.data != null ? agencyDoc.data.loanTypeLimit : 1;
    }
    
    function getMaxCustomers(agencyId) {
      let agencyDoc = get(/databases/$(database)/documents/agencies/$(agencyId));
      return agencyDoc != null && agencyDoc.data != null ? agencyDoc.data.maxCustomers : 50;
    }
    
    function getMaxActiveLoans(agencyId) {
      let agencyDoc = get(/databases/$(database)/documents/agencies/$(agencyId));
      return agencyDoc != null && agencyDoc.data != null ? agencyDoc.data.maxActiveLoans : 30;
    }
    
    // Users collection
    match /users/{userId} {
      // Allow users to read their own document, or any authenticated user can read (needed for getUserAgencyId helper)
      // This is safe because user documents don't contain sensitive data beyond what's needed for auth
      allow read: if isAuthenticated();
      
      // Allow create if:
      // 1. User is creating their OWN document (request.auth.uid == userId), OR
      // 2. Document ID matches the authenticated user's UID
      // This is critical for invitation acceptance where a NEW user signs up and creates their profile
      // NOTE: We use request.auth.uid == userId directly without helper functions because
      // helper functions like getUserRole() try to read the user doc that doesn't exist yet
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Allow update if:
      // 1. User is updating their own document, OR
      // 2. Admin is updating a user in their agency
      // NOTE: For new users accepting invitations, they may update their own doc before belonging to an agency
      allow update: if request.auth != null && (
        request.auth.uid == userId || 
        (isAdmin() && (resource == null || belongsToAgency(resource.data.agency_id)))
      );
      allow delete: if isAuthenticated() && isAdmin();
      
      // User notifications
      match /notifications/{notificationId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;
        allow create: if isAuthenticated();
        allow update: if isAuthenticated() && request.auth.uid == userId;
        allow delete: if isAuthenticated() && request.auth.uid == userId;
      }
    }
    
    // Agencies collection
    match /agencies/{agencyId} {
      // Allow reading if:
      // 1. User belongs to agency, OR
      // 2. User created the agency, OR
      // 3. User is an employee of the agency, OR
      // 4. For list queries, allow authenticated users (client will filter)
      allow list: if isAuthenticated();
      allow get: if isAuthenticated() && (
        belongsToAgency(agencyId) || 
        (resource != null && resource.data != null && resource.data.createdBy == request.auth.uid) ||
        exists(/databases/$(database)/documents/agencies/$(agencyId)/employees/$(request.auth.uid))
      );
      allow create: if isAuthenticated();
      // Allow admins to update agency settings (including loanSettings) and other agency data
      // Also allow agency creator to update their own agency
      allow update: if isAuthenticated() && ((isAdmin() && belongsToAgency(agencyId)) || (resource != null && resource.data.createdBy == request.auth.uid));
      allow delete: if isAuthenticated() && ((isAdmin() && belongsToAgency(agencyId)) || (resource != null && resource.data.createdBy == request.auth.uid));
      
      // Employees subcollection
      match /employees/{employeeId} {
        allow read: if isAuthenticated() && (belongsToAgency(agencyId) || (resource != null && resource.data.userId == request.auth.uid));
        // Allow create if:
        // 1. User belongs to agency and is admin/loan officer, OR
        // 2. User is creating their own employee record (for invitation acceptance flow)
        allow create: if isAuthenticated() && (
          ((isAdmin() || isLoanOfficer()) && belongsToAgency(agencyId)) ||
          (request.resource.data.userId == request.auth.uid)
        );
        allow update: if isAuthenticated() && (isAdmin() || (isEmployee() && resource != null && resource.data.userId == request.auth.uid)) && belongsToAgency(agencyId);
        allow delete: if isAuthenticated() && (isAdmin() || (resource != null && resource.data.userId == request.auth.uid)) && belongsToAgency(agencyId);
      }
      
      // Invitations subcollection
      match /invitations/{inviteId} {
        // Allow reading invitations:
        // 1. If user belongs to agency (for viewing invitations list)
        // 2. If invitation is pending - allow ANY read for pending invitations
        //    This enables token-based lookup before user is authenticated
        //    The token itself serves as the "password" - only those with the link can access
        allow read: if 
          (isAuthenticated() && belongsToAgency(agencyId)) ||
          (resource != null && resource.data.status == 'pending');
        
        // Also allow list queries for pending invitations (needed for token lookup)
        // Security: Token is a random string that serves as authentication
        allow list: if isAuthenticated() && belongsToAgency(agencyId);
        
        // Allow create if user belongs to agency and is admin/loan officer/employee
        // Employees can also create invitations when creating customers
        allow create: if isAuthenticated() && belongsToAgency(agencyId) && (isAdmin() || isLoanOfficer() || isEmployee());
        
        // Allow update for accepting invitations:
        // 1. If user belongs to agency (for admins updating status)
        // 2. If authenticated user is accepting a pending invitation
        //    - Any authenticated user can accept if the invitation is pending
        //    - This allows NEW users who just signed up to mark their invitation as accepted
        //    - Must be updating status to 'accepted' and setting acceptedBy to their own uid
        allow update: if 
          (isAuthenticated() && belongsToAgency(agencyId)) ||
          (isAuthenticated() && 
           resource != null && 
           resource.data.status == 'pending' &&
           request.resource.data.status == 'accepted' &&
           request.resource.data.acceptedBy == request.auth.uid);
        
        allow delete: if isAuthenticated() && (isAdmin() || (resource != null && resource.data.createdBy == request.auth.uid)) && belongsToAgency(agencyId);
      }
      
      // Customers subcollection
      match /customers/{customerId} {
        allow read: if isAuthenticated() && (belongsToAgency(agencyId) || (resource != null && resource.data.userId == request.auth.uid) || isCustomer());
        // Allow create if:
        // 1. User belongs to agency (from Firestore user doc), OR
        // 2. User is creating a customer with createdBy field matching their auth.uid
        // Note: Customer limit enforcement (maxCustomers) is done in Cloud Functions/Frontend
        // Rules here only enforce permissions, not business logic limits
        allow create: if isAuthenticated() && (
          belongsToAgency(agencyId) ||
          request.resource.data.createdBy == request.auth.uid
        );
        // Allow update if:
        // 1. User belongs to agency (loan officers, admins, employees can update), OR
        // 2. User is linking themselves to the customer record (for invitation acceptance)
        //    - Allow ANY authenticated user to update if they're setting userId to their own uid
        //    - This is safe because you can only link yourself to a customer, not others
        //    - Also allow if they're only updating userId field (for invitation acceptance flow)
        allow update: if isAuthenticated() && (
          (belongsToAgency(agencyId) && (isLoanOfficer() || isAdmin() || isEmployee())) ||
          (request.resource.data.userId == request.auth.uid) ||
          // Allow if only updating userId field and it matches auth.uid (for new users accepting invitations)
          (request.resource.data.userId == request.auth.uid && 
           resource != null && 
           resource.data.userId == null)
        );
        // Allow delete if:
        // 1. User belongs to agency AND is loan officer/admin/employee, OR
        // 2. User is deleting their own customer record
        // Note: Active loan check is done in Cloud Functions - rules only check permissions
        allow delete: if isAuthenticated() && (
          (belongsToAgency(agencyId) && (isLoanOfficer() || isAdmin() || isEmployee())) ||
          (resource != null && resource.data.userId == request.auth.uid)
        );
        
        // Customer documents subcollection
        match /documents/{documentId} {
          allow read: if isAuthenticated() && (belongsToAgency(agencyId) || (resource != null && resource.data.uploadedBy == request.auth.uid));
          // Allow create if user belongs to agency OR is uploading their own document OR is a customer
          allow create: if isAuthenticated() && (
            belongsToAgency(agencyId) ||
            (request.resource.data.uploadedBy == request.auth.uid) ||
            isCustomer()
          );
          allow update: if isAuthenticated() && (belongsToAgency(agencyId) || (resource != null && resource.data.uploadedBy == request.auth.uid));
          allow delete: if isAuthenticated() && (belongsToAgency(agencyId) || (resource != null && resource.data.uploadedBy == request.auth.uid));
        }
      }
      
      // Loans subcollection
      match /loans/{loanId} {
        allow read: if isAuthenticated() && (belongsToAgency(agencyId) || isLoanOwner(loanId, agencyId) || (resource != null && isCustomerOwner(resource.data.customerId, agencyId)));
        // Note: Active loan limit enforcement (maxActiveLoans) is done in Cloud Functions/Frontend
        // Rules here only enforce permissions, not business logic limits
        // Firestore rules cannot iterate/count - enforcement happens in Cloud Functions
        // Loan type enabled/disabled validation happens in Cloud Functions
        // Allow create if user belongs to agency and is admin/loan officer/employee
        // Employees can create loans when originating them
        allow create: if isAuthenticated() && belongsToAgency(agencyId) && (isLoanOfficer() || isAdmin() || isEmployee());
        
        // Update rules based on workflow:
        // - Admins can update any loan (all fields, all statuses)
        // - Accountants can update status and financial fields for active loans
        // - Loan officers can update loans they manage (status changes, disbursement, payments)
        // - Employees with agency access can update loan status and record payments
        // - For DRAFT loans: loan officers can edit all fields
        // - For other statuses: loan officers can update status field for workflow transitions
        allow update: if isAuthenticated() && belongsToAgency(agencyId) && (
          // Admin can update any loan
          isAdmin() ||
          // Accountant can update any loan status and financial fields
          isAccountant() ||
          // Loan officer can update:
          // 1. DRAFT loans (can edit all fields)
          // 2. Any loan for status updates (workflow transitions)
          (isLoanOfficer() && (
            resource.data.status == 'draft' ||
            resource.data.status == null ||
            resource.data.status == '' ||
            // Allow status updates - check if status field is being changed
            request.resource.data.status != resource.data.status
          )) ||
          // Any employee with agency access can update (for bulk operations and status changes)
          isEmployee()
        );
        
        // Delete rules:
        // - Only DRAFT or REJECTED loans can be deleted
        // - Admins can delete any loan
        // - Loan officers can delete DRAFT/REJECTED loans
        // - Accountants can delete DRAFT/REJECTED loans
        // Note: Repayment check is done in Cloud Functions - rules only check status and permissions
        allow delete: if isAuthenticated() && belongsToAgency(agencyId) && (
          // Admin can delete any loan
          isAdmin() ||
          // Loan officers/accountants/employees can only delete DRAFT or REJECTED loans
          ((isLoanOfficer() || isAccountant() || isEmployee()) && 
           resource != null && 
           resource.data != null && 
           (resource.data.status == 'draft' || resource.data.status == 'rejected'))
        );
        
        // Loan documents subcollection
        match /documents/{documentId} {
          allow read: if isAuthenticated() && (belongsToAgency(agencyId) || isLoanOwner(loanId, agencyId));
          // Allow employees to create/update/delete loan documents
          allow create: if isAuthenticated() && belongsToAgency(agencyId) && (isLoanOfficer() || isAdmin() || isEmployee());
          allow update: if isAuthenticated() && belongsToAgency(agencyId) && (isLoanOfficer() || isAdmin() || isEmployee());
          allow delete: if isAuthenticated() && belongsToAgency(agencyId) && (isLoanOfficer() || isAdmin() || isEmployee());
        }
        
        // Loan collateral subcollection
        match /collateral/{collateralId} {
          allow read: if isAuthenticated() && (belongsToAgency(agencyId) || isLoanOwner(loanId, agencyId));
          // Allow employees to create/update/delete loan collateral
          allow create: if isAuthenticated() && belongsToAgency(agencyId) && (isLoanOfficer() || isAdmin() || isEmployee());
          allow update: if isAuthenticated() && belongsToAgency(agencyId) && (isLoanOfficer() || isAdmin() || isEmployee());
          allow delete: if isAuthenticated() && belongsToAgency(agencyId) && (isLoanOfficer() || isAdmin() || isEmployee());
        }
        
        // Loan repayments subcollection
        match /repayments/{repaymentId} {
          allow read: if isAuthenticated() && (belongsToAgency(agencyId) || isAccountant() || isCustomer());
          // Accountants, admins, and loan officers can create/edit repayment schedules
          // Loan officers need this for recording payments via bulk update or individual payment recording
          allow create: if isAuthenticated() && (isAccountant() || isAdmin() || isLoanOfficer() || isEmployee()) && belongsToAgency(agencyId);
          allow update: if isAuthenticated() && (isAccountant() || isAdmin() || isLoanOfficer() || isEmployee()) && belongsToAgency(agencyId);
          allow delete: if isAuthenticated() && (isAdmin() || isAccountant()) && belongsToAgency(agencyId);
          
          // Payment history subcollection
          match /paymentHistory/{paymentId} {
            allow read: if isAuthenticated() && belongsToAgency(agencyId);
            // Allow any authenticated employee to create payment history entries
            // This is needed for bulk payment recording and individual payment recording
            allow create: if isAuthenticated() && (isLoanOfficer() || isAccountant() || isAdmin() || isEmployee()) && belongsToAgency(agencyId);
            allow update: if false; // Payment history should never be updated
            allow delete: if isAuthenticated() && isAdmin() && belongsToAgency(agencyId);
          }
        }
        
        // Ad-hoc payments subcollection (for loans without repayment schedules)
        match /payments/{paymentId} {
          allow read: if isAuthenticated() && (belongsToAgency(agencyId) || isAccountant() || isLoanOwner(loanId, agencyId));
          // Loan officers, accountants, admins can record payments
          allow create: if isAuthenticated() && (isLoanOfficer() || isAccountant() || isAdmin() || isEmployee()) && belongsToAgency(agencyId);
          allow update: if false; // Payments should never be updated (immutable)
          allow delete: if isAuthenticated() && isAdmin() && belongsToAgency(agencyId); // Only admin can delete
        }
        
        // Loan transactions subcollection
        match /transactions/{transactionId} {
          allow read: if isAuthenticated() && (belongsToAgency(agencyId) || isAccountant() || isLoanOwner(loanId, agencyId));
          allow create: if isAuthenticated() && (isLoanOfficer() || isAccountant() || isAdmin()) && belongsToAgency(agencyId);
          allow update: if isAuthenticated() && (isAccountant() || isAdmin()) && belongsToAgency(agencyId);
          allow delete: if isAuthenticated() && (isAdmin() || isAccountant()) && belongsToAgency(agencyId);
        }
        
        // Loan audit logs subcollection (immutable)
        match /audit_logs/{logId} {
          allow read: if isAuthenticated() && belongsToAgency(agencyId);
          allow create: if isAuthenticated() && belongsToAgency(agencyId);
          allow update: if false; // Audit logs are immutable
          allow delete: if false; // Audit logs cannot be deleted
        }
      }
      
      // Top-level collateral registry
      // All authenticated agency users can manage collateral
      // Feature gating for AI valuation is done at the Cloud Function level
      match /collateral/{collateralId} {
        allow read: if isAuthenticated() && (belongsToAgency(agencyId) || isCustomer());
        // Allow loan officers, admins, accountants, and employees to create/update/delete collateral
        allow create: if isAuthenticated() 
          && (isLoanOfficer() || isAdmin() || isAccountant() || isEmployee()) 
          && belongsToAgency(agencyId);
        allow update: if isAuthenticated() 
          && (isLoanOfficer() || isAdmin() || isAccountant() || isEmployee()) 
          && belongsToAgency(agencyId);
        allow delete: if isAuthenticated() 
          && (isAdmin() || isLoanOfficer() || isAccountant()) 
          && belongsToAgency(agencyId);
      }
      
      // Audit logs subcollection
      match /audit_logs/{logId} {
        allow read: if isAuthenticated() && (isAdmin() || isEmployee()) && belongsToAgency(agencyId);
        // Allow create if user belongs to agency OR if actorId matches authenticated user
        // (handles cases where user data is in Supabase)
        allow create: if isAuthenticated() && (
          belongsToAgency(agencyId) ||
          request.resource.data.actorId == request.auth.uid
        );
        allow update: if false; // Audit logs should never be updated
        allow delete: if isAuthenticated() && isAdmin() && belongsToAgency(agencyId);
      }
      
      // Reports subcollection (for accountants)
      match /reports/{reportId} {
        allow read: if isAuthenticated() && (isAccountant() || isAdmin()) && belongsToAgency(agencyId);
        allow create: if isAuthenticated() && (isAccountant() || isAdmin()) && belongsToAgency(agencyId);
        allow update: if isAuthenticated() && (isAccountant() || isAdmin()) && belongsToAgency(agencyId);
        allow delete: if isAuthenticated() && (isAdmin() || isAccountant()) && belongsToAgency(agencyId);
      }
      
      // Notifications subcollection
      match /notifications/{notificationId} {
        allow read: if isAuthenticated() && belongsToAgency(agencyId);
        allow create: if isAuthenticated() && belongsToAgency(agencyId);
        allow update: if isAuthenticated() && belongsToAgency(agencyId);
        allow delete: if isAuthenticated() && belongsToAgency(agencyId);
      }
      
      // Stats subcollection (cached dashboard statistics)
      match /stats/{statId} {
        allow read: if isAuthenticated() && belongsToAgency(agencyId);
        allow create: if isAuthenticated() && belongsToAgency(agencyId);
        allow update: if isAuthenticated() && belongsToAgency(agencyId);
        allow delete: if isAuthenticated() && isAdmin() && belongsToAgency(agencyId);
      }
      
      // Loan type configuration subcollection
      // Note: Loan type limit enforcement is done in Cloud Functions/Frontend
      // Rules here only enforce permissions, not business logic limits
      // Firestore rules cannot iterate/count - enforcement happens in Cloud Functions
      match /config/{configId} {
        allow read: if isAuthenticated() && belongsToAgency(agencyId);
        allow create: if isAuthenticated() && (isAdmin() || isLoanOfficer()) && belongsToAgency(agencyId);
        allow update: if isAuthenticated() && isAdmin() && belongsToAgency(agencyId);
        allow delete: if isAuthenticated() && isAdmin() && belongsToAgency(agencyId);
      }
      
      // Alerts subcollection
      match /alerts/{alertId} {
        allow read: if isAuthenticated() && belongsToAgency(agencyId);
        allow create: if isAuthenticated() && belongsToAgency(agencyId);
        allow update: if isAuthenticated() && belongsToAgency(agencyId);
        allow delete: if isAuthenticated() && isAdmin() && belongsToAgency(agencyId);
      }
      
      // Support tickets subcollection
      match /support_tickets/{ticketId} {
        // All agency members can read their own tickets, admins can read all
        allow read: if isAuthenticated() && belongsToAgency(agencyId) && (
          (resource != null && resource.data.createdBy == request.auth.uid) ||
          isAdmin()
        );
        // Any authenticated user in the agency can create tickets
        allow create: if isAuthenticated() && belongsToAgency(agencyId);
        // Only admins can update tickets (for status changes, assignments)
        allow update: if isAuthenticated() && belongsToAgency(agencyId) && isAdmin();
        // Only admins can delete tickets
        allow delete: if isAuthenticated() && belongsToAgency(agencyId) && isAdmin();
      }
      
      // Import logs subcollection (for bulk import audit trails)
      match /import_logs/{logId} {
        allow read: if isAuthenticated() && belongsToAgency(agencyId);
        allow create: if isAuthenticated() && belongsToAgency(agencyId);
        allow update: if false; // Import logs are immutable
        allow delete: if false; // Import logs cannot be deleted
      }
      
      // Tasks subcollection
      match /tasks/{taskId} {
        // Allow read if:
        // 1. User belongs to agency and is assigned to the task, OR
        // 2. User is admin/manager (can see all tasks), OR
        // 3. User assigned the task
        allow read: if isAuthenticated() && belongsToAgency(agencyId) && (
          (resource != null && resource.data.assignedToUserId == request.auth.uid) ||
          (resource != null && resource.data.assignedByUserId == request.auth.uid) ||
          isAdmin() ||
          (getUserRole() == 'employee' && getUserEmployeeCategory() == 'manager')
        );
        
        // Allow create if user belongs to agency and is admin/manager
        allow create: if isAuthenticated() && belongsToAgency(agencyId) && (
          isAdmin() ||
          (getUserRole() == 'employee' && getUserEmployeeCategory() == 'manager')
        );
        
        // Allow update if:
        // 1. User is assigned to the task (can update status), OR
        // 2. User is admin/manager (can update any task)
        allow update: if isAuthenticated() && belongsToAgency(agencyId) && (
          (resource != null && resource.data.assignedToUserId == request.auth.uid) ||
          isAdmin() ||
          (getUserRole() == 'employee' && getUserEmployeeCategory() == 'manager')
        );
        
        // Allow delete if user is admin/manager
        allow delete: if isAuthenticated() && belongsToAgency(agencyId) && (
          isAdmin() ||
          (getUserRole() == 'employee' && getUserEmployeeCategory() == 'manager')
        );
      }
      
      // Customer invitations subcollection (for automated onboarding)
      match /customer_invitations/{invitationId} {
        // Allow read to anyone (token verification done in code)
        allow read: if true;
        // Only Cloud Functions can create (no direct client access needed)
        allow create: if isAuthenticated() && belongsToAgency(agencyId);
        // Allow update for status changes (accepted, expired)
        allow update: if isAuthenticated();
        // Only admins can delete
        allow delete: if isAuthenticated() && isAdmin() && belongsToAgency(agencyId);
      }
      
      // Loan packages subcollection (Enterprise feature)
      match /loan_packages/{packageId} {
        // Anyone in agency can read packages
        allow read: if isAuthenticated() && belongsToAgency(agencyId);
        // Only admins can create/update/delete (Enterprise plan enforced in Cloud Functions)
        allow create: if isAuthenticated() && isAdmin() && belongsToAgency(agencyId);
        allow update: if isAuthenticated() && isAdmin() && belongsToAgency(agencyId);
        allow delete: if isAuthenticated() && isAdmin() && belongsToAgency(agencyId);
      }
      
      // Notification config subcollection (Enterprise templates)
      match /notification_config/{configId} {
        // Anyone in agency can read notification config
        allow read: if isAuthenticated() && belongsToAgency(agencyId);
        // Only admins can create/update/delete (Enterprise plan enforced in Cloud Functions)
        allow create: if isAuthenticated() && isAdmin() && belongsToAgency(agencyId);
        allow update: if isAuthenticated() && isAdmin() && belongsToAgency(agencyId);
        allow delete: if isAuthenticated() && isAdmin() && belongsToAgency(agencyId);
      }
    }
    
    // AI logs collection (read-only for employees, full access for admins)
    // AI insights feature check (Starter plan doesn't have this feature)
    match /ai_logs/{logId} {
      allow read: if isAuthenticated() && (isAdmin() || isEmployee());
      // Starter plan doesn't have AI insights feature
      allow create: if isAuthenticated() && hasFeature(getUserAgencyId(), 'aiInsights');
      allow update: if isAuthenticated() && isAdmin() && hasFeature(getUserAgencyId(), 'aiInsights');
      allow delete: if isAuthenticated() && isAdmin() && hasFeature(getUserAgencyId(), 'aiInsights');
    }
    
    // App settings (admin only)
    match /app_settings/{settingId} {
      allow read: if isAuthenticated() && isAdmin();
      allow create: if isAuthenticated() && isAdmin();
      allow update: if isAuthenticated() && isAdmin();
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // Invitation tokens collection (public read for token lookup)
    // This enables unauthenticated users to look up invitations by token
    // The token itself serves as authentication - only those with the link can access
    // Documents: { token: string, agencyId: string, inviteId: string, status: string, expiresAt: timestamp }
    match /invitation_tokens/{tokenId} {
      // Allow ANY read - the token itself is the secret (only those with the invite link know it)
      // We check status in the application code
      allow read: if true;
      // Only authenticated agency members can create tokens (done when invitation is created)
      allow create: if isAuthenticated();
      // Allow authenticated users to update (mark as accepted)
      // Must be updating status to 'accepted' and setting acceptedBy to their own uid
      allow update: if isAuthenticated() && 
        request.resource.data.status == 'accepted' &&
        request.resource.data.acceptedBy == request.auth.uid;
      // Only admins can delete
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // Referrals collection
    match /referrals/{referralId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // AI Cache collection (for DeepSeek API response caching)
    match /ai_cache/{cacheKey} {
      // Only Cloud Functions can read/write cache
      // Clients should never access this directly
      allow read: if false; // No direct client access
      allow create: if false; // Only Cloud Functions
      allow update: if false;
      allow delete: if false;
    }
    
    // Marketplace leads collection (public marketplace)
    match /marketplace_leads/{leadId} {
      // Public read for borrowers to check their own application status
      // Agency members can read leads for their agency
      allow read: if 
        isAuthenticated() && (
          // Borrower can read their own lead
          (resource != null && resource.data.borrowerEmail == request.auth.token.email) ||
          // Agency members can read leads for their agency
          (belongsToAgency(resource.data.targetAgencyId))
        );
      
      // Anyone can create a lead (public marketplace application)
      allow create: if true;
      
      // Only agency members can update (accept/reject)
      allow update: if isAuthenticated() && belongsToAgency(resource.data.targetAgencyId) && (isAdmin() || isLoanOfficer());
      
      // Only admins can delete
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // Marketplace agency profiles (public lender profiles)
    match /marketplace_profiles/{profileId} {
      // Public read - anyone can view lender profiles
      allow read: if true;
      
      // Only agency admins can create/update their profile
      allow create: if isAuthenticated() && isAdmin() && belongsToAgency(profileId);
      allow update: if isAuthenticated() && isAdmin() && belongsToAgency(profileId);
      
      // Only admins can delete
      allow delete: if isAuthenticated() && isAdmin() && belongsToAgency(profileId);
    }
  }
}
