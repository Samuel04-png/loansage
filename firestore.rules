rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserAgencyId() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null && userDoc.data != null ? userDoc.data.agency_id : null;
    }
    
    function getUserRole() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null && userDoc.data != null ? userDoc.data.role : null;
    }
    
    function isAdmin() {
      return getUserRole() == 'admin';
    }
    
    function isEmployee() {
      return getUserRole() == 'employee';
    }
    
    function isCustomer() {
      return getUserRole() == 'customer';
    }
    
    function isAccountant() {
      return getUserRole() == 'accountant' || getUserRole() == 'admin';
    }
    
    function isLoanOfficer() {
      return isAdmin() || isEmployee();
    }
    
    function belongsToAgency(agencyId) {
      let userAgencyId = getUserAgencyId();
      return userAgencyId == agencyId;
    }
    
    function isCustomerOwner(customerId, agencyId) {
      let customerDoc = get(/databases/$(database)/documents/agencies/$(agencyId)/customers/$(customerId));
      return customerDoc != null && customerDoc.data.userId == request.auth.uid;
    }
    
    function isLoanOwner(loanId, agencyId) {
      let loanDoc = get(/databases/$(database)/documents/agencies/$(agencyId)/loans/$(loanId));
      return loanDoc != null && loanDoc.data.customerId != null 
        ? isCustomerOwner(loanDoc.data.customerId, agencyId) 
        : false;
    }
    
    // Users collection
    match /users/{userId} {
      // Allow users to read their own document, or any authenticated user can read (needed for getUserAgencyId helper)
      // This is safe because user documents don't contain sensitive data beyond what's needed for auth
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && (request.auth.uid == userId || (isAdmin() && (resource == null || belongsToAgency(resource.data.agency_id))));
      allow delete: if isAuthenticated() && isAdmin();
      
      // User notifications
      match /notifications/{notificationId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;
        allow create: if isAuthenticated();
        allow update: if isAuthenticated() && request.auth.uid == userId;
        allow delete: if isAuthenticated() && request.auth.uid == userId;
      }
    }
    
    // Agencies collection
    match /agencies/{agencyId} {
      // Allow reading if:
      // 1. User belongs to agency, OR
      // 2. User created the agency, OR
      // 3. User is an employee of the agency, OR
      // 4. For list queries, allow authenticated users (client will filter)
      allow list: if isAuthenticated();
      allow get: if isAuthenticated() && (
        belongsToAgency(agencyId) || 
        (resource != null && resource.data != null && resource.data.createdBy == request.auth.uid) ||
        exists(/databases/$(database)/documents/agencies/$(agencyId)/employees/$(request.auth.uid))
      );
      allow create: if isAuthenticated();
      // Allow admins to update agency settings (including loanSettings) and other agency data
      // Also allow agency creator to update their own agency
      allow update: if isAuthenticated() && ((isAdmin() && belongsToAgency(agencyId)) || (resource != null && resource.data.createdBy == request.auth.uid));
      allow delete: if isAuthenticated() && ((isAdmin() && belongsToAgency(agencyId)) || (resource != null && resource.data.createdBy == request.auth.uid));
      
      // Employees subcollection
      match /employees/{employeeId} {
        allow read: if isAuthenticated() && (belongsToAgency(agencyId) || (resource != null && resource.data.userId == request.auth.uid));
        // Allow create if:
        // 1. User belongs to agency and is admin/loan officer, OR
        // 2. User is creating their own employee record (for invitation acceptance flow)
        allow create: if isAuthenticated() && (
          ((isAdmin() || isLoanOfficer()) && belongsToAgency(agencyId)) ||
          (request.resource.data.userId == request.auth.uid)
        );
        allow update: if isAuthenticated() && (isAdmin() || (isEmployee() && resource != null && resource.data.userId == request.auth.uid)) && belongsToAgency(agencyId);
        allow delete: if isAuthenticated() && (isAdmin() || (resource != null && resource.data.userId == request.auth.uid)) && belongsToAgency(agencyId);
      }
      
      // Invitations subcollection
      match /invitations/{inviteId} {
        // Allow reading invitations:
        // 1. If user belongs to agency (for viewing invitations list)
        // 2. If invitation is pending (for token-based lookup during acceptance)
        allow read: if 
          (isAuthenticated() && belongsToAgency(agencyId)) ||
          (resource != null && resource.data.status == 'pending');
        allow create: if isAuthenticated() && (isAdmin() || isLoanOfficer()) && belongsToAgency(agencyId);
        // Allow update for accepting invitations:
        // 1. If user belongs to agency (for admins updating status)
        // 2. If invitation is pending and being marked as accepted (for new users accepting)
        //    - This allows NEW users to accept invitations even before they belong to the agency
        //    - Only allow changing status from 'pending' to 'accepted'
        //    - Only allow setting acceptedBy and acceptedAt fields
        //    - Don't allow changing other fields
        allow update: if 
          (isAuthenticated() && belongsToAgency(agencyId)) ||
          (isAuthenticated() && 
           resource != null && 
           resource.data.status == 'pending' && 
           request.resource.data.status == 'accepted' &&
           // Only allow changing status, acceptedBy, and acceptedAt
           // Prevent changing other important fields
           request.resource.data.email == resource.data.email &&
           request.resource.data.role == resource.data.role &&
           request.resource.data.token == resource.data.token &&
           request.resource.data.createdBy == resource.data.createdBy &&
           request.resource.data.expiresAt == resource.data.expiresAt &&
           request.resource.data.inviteUrl == resource.data.inviteUrl &&
           (request.resource.data.customerId == null || request.resource.data.customerId == resource.data.customerId));
        allow delete: if isAuthenticated() && (isAdmin() || (resource != null && resource.data.createdBy == request.auth.uid)) && belongsToAgency(agencyId);
      }
      
      // Customers subcollection
      match /customers/{customerId} {
        allow read: if isAuthenticated() && (belongsToAgency(agencyId) || (resource != null && resource.data.userId == request.auth.uid) || isCustomer());
        // Allow create if:
        // 1. User belongs to agency (from Firestore user doc), OR
        // 2. User is creating a customer with createdBy field matching their auth.uid
        //    (This handles cases where user data is in Supabase - we trust the client
        //     to set createdBy correctly, and the application logic enforces this)
        allow create: if isAuthenticated() && (
          belongsToAgency(agencyId) ||
          request.resource.data.createdBy == request.auth.uid
        );
        // Allow update if:
        // 1. User belongs to agency, OR
        // 2. User is linking themselves to the customer record (for invitation acceptance)
        allow update: if isAuthenticated() && (
          belongsToAgency(agencyId) ||
          (resource != null && request.resource.data.userId == request.auth.uid && resource.data.userId == null)
        );
        allow delete: if isAuthenticated() && (belongsToAgency(agencyId) || (resource != null && resource.data.userId == request.auth.uid));
        
        // Customer documents subcollection
        match /documents/{documentId} {
          allow read: if isAuthenticated() && (belongsToAgency(agencyId) || (resource != null && resource.data.uploadedBy == request.auth.uid));
          // Allow create if user belongs to agency OR is uploading their own document OR is a customer
          allow create: if isAuthenticated() && (
            belongsToAgency(agencyId) ||
            (request.resource.data.uploadedBy == request.auth.uid) ||
            isCustomer()
          );
          allow update: if isAuthenticated() && (belongsToAgency(agencyId) || (resource != null && resource.data.uploadedBy == request.auth.uid));
          allow delete: if isAuthenticated() && (belongsToAgency(agencyId) || (resource != null && resource.data.uploadedBy == request.auth.uid));
        }
      }
      
      // Loans subcollection
      match /loans/{loanId} {
        allow read: if isAuthenticated() && (belongsToAgency(agencyId) || isLoanOwner(loanId, agencyId) || (resource != null && isCustomerOwner(resource.data.customerId, agencyId)));
        allow create: if isAuthenticated() && (isLoanOfficer() || isAdmin()) && belongsToAgency(agencyId);
        
        // Update rules based on workflow:
        // - Loan officers can only edit DRAFT loans they created
        // - Accountants can update status for PENDING/UNDER_REVIEW loans
        // - Admins can update any loan
        allow update: if isAuthenticated() && belongsToAgency(agencyId) && (
          // Admin can update any loan
          isAdmin() ||
          // Loan officer can only update DRAFT loans they created
          (isLoanOfficer() && 
           resource != null && 
           resource.data.status == 'draft' && 
           resource.data.createdBy == request.auth.uid &&
           request.resource.data.status in ['draft', 'pending']) ||
          // Accountant can update status for PENDING/UNDER_REVIEW loans
          (isAccountant() && 
           resource != null && 
           resource.data.status in ['pending', 'under_review', 'approved'] &&
           // Only allow status changes, not other field edits
           request.resource.data.status in ['pending', 'under_review', 'approved', 'rejected'])
        );
        
        allow delete: if isAuthenticated() && (isAdmin() || (isLoanOfficer() && resource != null && resource.data.status == 'draft' && resource.data.createdBy == request.auth.uid)) && belongsToAgency(agencyId);
        
        // Loan documents subcollection
        match /documents/{documentId} {
          allow read: if isAuthenticated() && (belongsToAgency(agencyId) || isLoanOwner(loanId, agencyId));
          allow create: if isAuthenticated() && (isLoanOfficer() || isAdmin()) && belongsToAgency(agencyId);
          allow update: if isAuthenticated() && (isLoanOfficer() || isAdmin()) && belongsToAgency(agencyId);
          allow delete: if isAuthenticated() && (isLoanOfficer() || isAdmin()) && belongsToAgency(agencyId);
        }
        
        // Loan collateral subcollection
        match /collateral/{collateralId} {
          allow read: if isAuthenticated() && (belongsToAgency(agencyId) || isLoanOwner(loanId, agencyId));
          allow create: if isAuthenticated() && (isLoanOfficer() || isAdmin()) && belongsToAgency(agencyId);
          allow update: if isAuthenticated() && (isLoanOfficer() || isAdmin()) && belongsToAgency(agencyId);
          allow delete: if isAuthenticated() && (isLoanOfficer() || isAdmin()) && belongsToAgency(agencyId);
        }
        
        // Loan repayments subcollection
        match /repayments/{repaymentId} {
          allow read: if isAuthenticated() && (belongsToAgency(agencyId) || isAccountant() || isCustomer());
          // Only accountants and admins can create/edit repayment schedules
          allow create: if isAuthenticated() && (isAccountant() || isAdmin()) && belongsToAgency(agencyId);
          allow update: if isAuthenticated() && (isAccountant() || isAdmin()) && belongsToAgency(agencyId);
          allow delete: if isAuthenticated() && (isAdmin() || isAccountant()) && belongsToAgency(agencyId);
          
          // Payment history subcollection
          match /paymentHistory/{paymentId} {
            allow read: if isAuthenticated() && belongsToAgency(agencyId);
            allow create: if isAuthenticated() && (isLoanOfficer() || isAccountant() || isAdmin()) && belongsToAgency(agencyId);
            allow update: if false; // Payment history should never be updated
            allow delete: if isAuthenticated() && isAdmin() && belongsToAgency(agencyId);
          }
        }
        
        // Loan transactions subcollection
        match /transactions/{transactionId} {
          allow read: if isAuthenticated() && (belongsToAgency(agencyId) || isAccountant() || isLoanOwner(loanId, agencyId));
          allow create: if isAuthenticated() && (isLoanOfficer() || isAccountant() || isAdmin()) && belongsToAgency(agencyId);
          allow update: if isAuthenticated() && (isAccountant() || isAdmin()) && belongsToAgency(agencyId);
          allow delete: if isAuthenticated() && (isAdmin() || isAccountant()) && belongsToAgency(agencyId);
        }
        
        // Loan audit logs subcollection (immutable)
        match /audit_logs/{logId} {
          allow read: if isAuthenticated() && belongsToAgency(agencyId);
          allow create: if isAuthenticated() && belongsToAgency(agencyId);
          allow update: if false; // Audit logs are immutable
          allow delete: if false; // Audit logs cannot be deleted
        }
      }
      
      // Top-level collateral registry
      match /collateral/{collateralId} {
        allow read: if isAuthenticated() && (belongsToAgency(agencyId) || isCustomer());
        allow create: if isAuthenticated() && (isLoanOfficer() || isAdmin()) && belongsToAgency(agencyId);
        allow update: if isAuthenticated() && (isLoanOfficer() || isAdmin()) && belongsToAgency(agencyId);
        allow delete: if isAuthenticated() && (isAdmin() || isLoanOfficer()) && belongsToAgency(agencyId);
      }
      
      // Audit logs subcollection
      match /audit_logs/{logId} {
        allow read: if isAuthenticated() && (isAdmin() || isEmployee()) && belongsToAgency(agencyId);
        // Allow create if user belongs to agency OR if actorId matches authenticated user
        // (handles cases where user data is in Supabase)
        allow create: if isAuthenticated() && (
          belongsToAgency(agencyId) ||
          request.resource.data.actorId == request.auth.uid
        );
        allow update: if false; // Audit logs should never be updated
        allow delete: if isAuthenticated() && isAdmin() && belongsToAgency(agencyId);
      }
      
      // Reports subcollection (for accountants)
      match /reports/{reportId} {
        allow read: if isAuthenticated() && (isAccountant() || isAdmin()) && belongsToAgency(agencyId);
        allow create: if isAuthenticated() && (isAccountant() || isAdmin()) && belongsToAgency(agencyId);
        allow update: if isAuthenticated() && (isAccountant() || isAdmin()) && belongsToAgency(agencyId);
        allow delete: if isAuthenticated() && (isAdmin() || isAccountant()) && belongsToAgency(agencyId);
      }
      
      // Notifications subcollection
      match /notifications/{notificationId} {
        allow read: if isAuthenticated() && belongsToAgency(agencyId);
        allow create: if isAuthenticated() && belongsToAgency(agencyId);
        allow update: if isAuthenticated() && belongsToAgency(agencyId);
        allow delete: if isAuthenticated() && belongsToAgency(agencyId);
      }
      
      // Stats subcollection (cached dashboard statistics)
      match /stats/{statId} {
        allow read: if isAuthenticated() && belongsToAgency(agencyId);
        allow create: if isAuthenticated() && belongsToAgency(agencyId);
        allow update: if isAuthenticated() && belongsToAgency(agencyId);
        allow delete: if isAuthenticated() && isAdmin() && belongsToAgency(agencyId);
      }
      
      // Loan type configuration subcollection
      match /config/{configId} {
        allow read: if isAuthenticated() && belongsToAgency(agencyId);
        allow create: if isAuthenticated() && (isAdmin() || isLoanOfficer()) && belongsToAgency(agencyId);
        allow update: if isAuthenticated() && isAdmin() && belongsToAgency(agencyId);
        allow delete: if isAuthenticated() && isAdmin() && belongsToAgency(agencyId);
      }
    }
    
    // AI logs collection (read-only for employees, full access for admins)
    match /ai_logs/{logId} {
      allow read: if isAuthenticated() && (isAdmin() || isEmployee());
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && isAdmin();
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // App settings (admin only)
    match /app_settings/{settingId} {
      allow read: if isAuthenticated() && isAdmin();
      allow create: if isAuthenticated() && isAdmin();
      allow update: if isAuthenticated() && isAdmin();
      allow delete: if isAuthenticated() && isAdmin();
    }
  }
}
